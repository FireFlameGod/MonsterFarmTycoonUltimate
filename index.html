<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monster Farm Tycoon - Izometrikus</title>
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden; /* Nincs g√∂rget√©s, ez teljes k√©perny≈ës j√°t√©k */
            touch-action: none; /* Mobilon letiltja a b√∂ng√©sz≈ë alapozott zoomol√°s√°t */
        }

        /* --- 1. LOGIN K√âPERNY≈ê (Megtartva a st√≠lusod) --- */
        #login-screen {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            z-index: 1000; /* Legyen legfel√ºl */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 10px;
        }

        h1 { color: #f1c40f; margin: 0 0 10px 0; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: none; box-sizing: border-box; font-size: 16px; }
        button { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; width: 100%; }
        .error { color: #e74c3c; display: none; font-weight: bold; }

        /* --- 2. J√ÅT√âK V√ÅSZON (CANVAS) --- */
        #game-canvas {
            display: block;
            background-color: #3498db; /* Tenger k√©k alapsz√≠n */
            width: 100%;
            height: 100vh;
            cursor: grab;
        }
        #game-canvas:active { cursor: grabbing; }

        /* --- 3. UI R√âTEG (HUD) --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* √Åt lehessen kattintani rajta a p√°ly√°ra */
            display: none; /* Indul√°skor rejtve */
        }

        .hud-bar {
            pointer-events: auto; /* A gombokra lehessen kattintani */
            background: rgba(0,0,0,0.6);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .player-info { font-weight: bold; font-size: 16px; }
        .money { color: #f1c40f; }
        
        #logout-btn {
            background: #c0392b; width: auto; padding: 5px 15px; font-size: 14px; margin: 0;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>ü¶ñ Monster Farm</h1>
        <p style="color:#bdc3c7; margin:0;">√âp√≠tsd fel a szigeted!</p>
        <input type="text" id="username" placeholder="Felhaszn√°l√≥n√©v">
        <input type="password" id="password" placeholder="Jelsz√≥">
        <button onclick="loginOrRegister()">Start</button>
        <div id="error-msg" class="error">Hib√°s jelsz√≥!</div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="ui-layer">
        <div class="hud-bar">
            <div class="player-info">
                üë§ <span id="player-name">Player</span> | 
                üí∞ <span id="money-display" class="money">0</span>
            </div>
            <button id="logout-btn" onclick="logout()">Kil√©p√©s</button>
        </div>
        
        <div style="position: absolute; bottom: 20px; right: 20px; pointer-events: auto;">
             <button onclick="addMoney()" style="background:#e67e22; width: auto; box-shadow: 0 4px 0 #d35400;">+50 P√©nz</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, update, increment, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- A TE FIREBASE CONFIGOD ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-MauYrQl5WZ4TPv53vNxuUFnW3dEG0Z8",
            authDomain: "monsterfarmtycoonultimate.firebaseapp.com",
            databaseURL: "https://monsterfarmtycoonultimate-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "monsterfarmtycoonultimate",
            storageBucket: "monsterfarmtycoonultimate.firebasestorage.app",
            messagingSenderId: "621935486358",
            appId: "1:621935486358:web:ac7d20b0beb3933f64e9b7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- J√ÅT√âK V√ÅLTOZ√ìK ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let currentPlayer = null;
        
        // T√©rk√©p be√°ll√≠t√°sok
        const tileW = 64; 
        const tileH = 32; 
        let mapOffsetX = window.innerWidth / 2; 
        let mapOffsetY = 150;

        // A SZIGET T√âRK√âPE (1 = F≈±, 0 = V√≠z)
        // Ez egy 10x10-es r√°cs
        const mapData = [
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,1,1,1,1,1,1,0,0],
            [0,1,1,1,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,1,1,0],
            [0,0,1,1,1,1,1,1,0,0],
            [0,0,0,0,0,0,0,0,0,0]
        ];

        // Mozgat√°s v√°ltoz√≥k
        let isDragging = false;
        let lastX, lastY;

        // --- 1. J√ÅT√âKMOTOR (CANVAS) ---
        
        // Ablak √°tm√©retez√©s kezel√©se
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawMap();
        }
        window.addEventListener('resize', resizeCanvas);

        // A F≈ë Rajzol√≥ F√ºggv√©ny
        function drawMap() {
            // K√©perny≈ë t√∂rl√©se
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Ciklus a t√©rk√©pen
            for (let y = 0; y < mapData.length; y++) {
                for (let x = 0; x < mapData[y].length; x++) {
                    
                    // Izometrikus transzform√°ci√≥ (Matek)
                    let screenX = (x - y) * (tileW / 2) + mapOffsetX;
                    let screenY = (x + y) * (tileH / 2) + mapOffsetY;

                    // Csak akkor rajzoljuk, ha k√©perny≈ën van (optimaliz√°l√°s alapja)
                    // (Itt most mindent rajzolunk egyszer≈±s√©g kedv√©√©rt)
                    drawTile(screenX, screenY, mapData[y][x]);
                }
            }
        }

        function drawTile(x, y, type) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + tileW / 2, y + tileH / 2);
            ctx.lineTo(x, y + tileH);
            ctx.lineTo(x - tileW / 2, y + tileH / 2);
            ctx.closePath();

            if (type === 1) {
                // F≈∞ (Z√∂ld sziget)
                ctx.fillStyle = "#2ecc71"; 
                ctx.fill();
                ctx.lineWidth = 1;
                ctx.strokeStyle = "#27ae60"; // Keret
                ctx.stroke();
            } else {
                // V√çZ (K√©k - csak halv√°nyan jelezz√ºk)
                ctx.fillStyle = "rgba(52, 152, 219, 0.3)";
                ctx.fill();
            }
        }

        // --- 2. MOZGAT√ÅS (DRAG & DROP) ---
        
        // Eg√©r esem√©nyek
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
        });

        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                let dx = e.clientX - lastX;
                let dy = e.clientY - lastY;
                mapOffsetX += dx;
                mapOffsetY += dy;
                lastX = e.clientX;
                lastY = e.clientY;
                drawMap();
            }
        });

        window.addEventListener('mouseup', () => isDragging = false);

        // √ârint≈ëk√©perny≈ë (Mobil) esem√©nyek
        canvas.addEventListener('touchstart', (e) => {
            isDragging = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            e.preventDefault(); // Hogy ne akarjon g√∂rgetni az oldal
        }, {passive: false});

        canvas.addEventListener('touchmove', (e) => {
            if (isDragging) {
                let dx = e.touches[0].clientX - lastX;
                let dy = e.touches[0].clientY - lastY;
                mapOffsetX += dx;
                mapOffsetY += dy;
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
                drawMap();
            }
            e.preventDefault();
        }, {passive: false});
        
        canvas.addEventListener('touchend', () => isDragging = false);


        // --- 3. LOGIN & FIREBASE LOGIKA (Integr√°lva) ---
        
        window.loginOrRegister = function() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('error-msg');

            if (!user || !pass) return;

            const dbRef = ref(db);
            get(child(dbRef, `users/${user}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    if (snapshot.val().password === pass) {
                        startGame(user);
                    } else {
                        errorDiv.style.display = 'block';
                    }
                } else {
                    set(ref(db, 'users/' + user), {
                        username: user, password: pass, money: 100, level: 1
                    }).then(() => startGame(user));
                }
            });
        };

        function startGame(user) {
            currentPlayer = user;
            // Ment√©s
            localStorage.setItem('mf_user', user);
            localStorage.setItem('mf_pass', document.getElementById('password').value);

            // UI v√°lt√°s
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            document.getElementById('player-name').innerText = user;

            // Canvas ind√≠t√°sa
            resizeCanvas(); 
            drawMap();

            // P√©nz figyel√©se
            onValue(ref(db, `users/${user}/money`), (snap) => {
                document.getElementById('money-display').innerText = snap.val();
            });
        }

        // Auto login
        window.onload = function() {
            const u = localStorage.getItem('mf_user');
            const p = localStorage.getItem('mf_pass');
            if(u && p) {
                document.getElementById('username').value = u;
                document.getElementById('password').value = p;
                window.loginOrRegister();
            }
        };

        window.addMoney = function() {
            if(currentPlayer) update(ref(db, `users/${currentPlayer}`), { money: increment(50) });
        };

        window.logout = function() {
            localStorage.clear();
            location.reload();
        };

    </script>
</body>
</html>